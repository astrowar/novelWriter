<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <!-- https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP -->
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' http: https:"
    />
    <meta
      http-equiv="X-Content-Security-Policy"
      content="default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline'; connect-src 'self' http: https:"
    />
    <title>Novel Writer - Book Structure</title>
    <style>
      /* Swiss Dessign inspired Theme - Adapted for NovelWriter */
      :root {
        /* Swiss Dessign Color Palette */
        --color-black: #000000;
        --color-white: #ffffff;
        --color-gray: #aeaeae;
        --color-light-gray: #f5f5f5;
        --color-border: #ddd;

        /* Semantic Colors */
        --bg-primary: var(--color-white);
        --bg-secondary: var(--color-light-gray);
        --bg-accent: var(--color-black);

        --text-primary: var(--color-black);
        --text-secondary: var(--color-gray);
        --text-on-dark: var(--color-white);

        --border-primary: var(--color-black);
        --border-secondary: var(--color-gray);
        --border-light: var(--color-border);
        --border-dotted: 1px dotted var(--color-black);

        /* Typography - Swiss Style */
        --font-primary: Garamond, "EB Garamond", Georgia, serif;
        --font-editor: Garamond, "EB Garamond", Georgia, serif;
        --font-size-xs: 12px;
        --font-size-sm: 13px;
        --font-size-base: 14px;
        --font-size-lg: 16px;
        --font-size-xl: 20px;
        --font-size-xxl: 28px;

        /* Spacing - Minimal */
        --spacing-xs: 3px;
        --spacing-sm: 5px;
        --spacing-md: 10px;
        --spacing-lg: 15px;
        --spacing-xl: 25px;

        /* Layout */
        --border-width: 1px;
        --top-bar-height: 6px;
      }

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        background: var(--bg-secondary);
        font-size: var(--font-size-sm);
        font-family: var(--font-primary);
        color: var(--text-primary);
        line-height: 1.5;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        height: 100vh;
      }

      a {
        color: var(--text-primary);
        text-decoration: none;
        transition: text-decoration 0.2s ease;
      }

      a:hover {
        text-decoration: line-through;
      }

      h1, h2, h3, h4, h5, h6 {
        margin: var(--spacing-md) 0;
        font-weight: normal;
      }

      h1 { font-size: var(--font-size-xxl); }
      h2 { font-size: var(--font-size-xl); }
      h3 { font-size: var(--font-size-base); }

      img {
        border: none;
      }

      .clear {
        clear: both;
      }

      .app-layout {
        display: flex;
        width: 100%;
        height: 100vh;
        flex-direction: column;
      }

      /* Top Black Bar - Swiss Dessign signature */
      .app-layout::before {
        content: '';
        display: block;
        height: var(--top-bar-height);
        background: var(--bg-accent);
        width: 100%;
      }

      /* Breadcrumb fixed at top */
      .breadcrumb-container {
        background: var(--bg-primary);
        border-bottom: var(--border-width) solid var(--border-light);
        padding: var(--spacing-md) var(--spacing-lg);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      /* App Container - Holds Codex + Panels */
      .app-container {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
      }

      /* Shared Codex Panel (Always Visible) */
      .codex-panel {
        width: 160px;
        background: var(--bg-primary);
        border-right: var(--border-width) solid var(--border-light);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        padding: var(--spacing-sm);
        flex-shrink: 0;
        z-index: 40;
      }

      /* Panels Container - Holds all 5 panels */
      .panels-container {
        flex: 1;
        position: relative;
        overflow: hidden;
      }

      /* App Panel Structure - All 5 panels use same structure */
      .app-panel {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        display: none;
        overflow-y: auto;
        background: var(--bg-secondary);
        z-index: 50;
      }

      .app-panel.active {
        display: block;
      }

      /* Info Panel Special Styles */
      #info-panel {
        background: #E8E4DC;
        padding: var(--spacing-xl);
      }

      /* Writer Panel - Swiss Design Grid Layout */
      #writer-panel {
        background: #D9D6D0;
        overflow-y: auto;
      }

      .writer-container {
        max-width: 1600px;
        margin: 0 auto;
        padding: 30px 20px;
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
      }

      .writer-grid {
        grid-column: 1 / -1;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 30px;
      }

      .writer-number {
        font-size: 120px;
        font-weight: 700;
        line-height: 0.9;
        color: #000000;
        font-family: var(--font-primary);
        letter-spacing: -0.02em;
      }

      .writer-content {
        flex: 1;
      }

      .writer-header {
        margin-bottom: 0;
      }

      .writer-title {
        font-size: 32px;
        font-weight: 700;
        line-height: 1.2;
        margin: 0;
        color: #000000;
        font-family: var(--font-primary);
      }

      .writer-title:focus {
        outline: 1px solid #000000;
        outline-offset: 4px;
      }

      .writer-columns {
        grid-column: 1 / -1;
        display: contents;
      }

      .writer-column {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .writer-column p {
        font-size: 11px;
        line-height: 1.6;
        color: #000000;
        margin: 0;
        text-align: justify;
        font-family: var(--font-primary);
      }

      .writer-column p:focus {
        outline: 1px solid #000000;
        outline-offset: 2px;
        background: rgba(255, 255, 255, 0.3);
      }

      .writer-sections {
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        gap: 0;
        margin-bottom: 60px;
      }

      .writer-section {
        display: grid;
        grid-template-columns: 0.7fr 1.3fr;
        gap: 30px;
        padding: 30px 0;
        border-top: 1px solid rgba(0, 0, 0, 0.3);
        border-bottom: 1px solid rgba(0, 0, 0, 0.3);
      }

      .writer-section:last-child {
        border-bottom: none;
      }

      .writer-section + .writer-section {
        border-top: none;
      }

      .section-summary {
        font-size: 14px;
        font-weight: 700;
        line-height: 1.4;
        margin: 0;
        color: #000000;
        font-family: var(--font-primary);
      }

      .section-content {
        display: flex;
        flex-direction: column;
        gap: 15px;
      }

      .section-content [contenteditable] {
        font-size: 16px;
        line-height: 1.6;
        color: #000000;
        margin: 0;
        text-align: justify;
        font-family: var(--font-primary);
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      .section-content [contenteditable]:focus {
        outline: 1px solid #000000;
        outline-offset: 2px;
        background: rgba(255, 255, 255, 0.3);
      }

      .section-heading {
        font-size: 14px;
        font-weight: 700;
        line-height: 1.4;
        margin: 0;
        color: #000000;
        font-family: var(--font-primary);
      }

      .section-heading:focus {
        outline: 1px solid #000000;
        outline-offset: 3px;
      }

      .writer-footer {
        grid-column: 1 / -1;
        padding-top: 40px;
        border-top: 2px solid #000000;
        display: flex;
        justify-content: flex-end;
      }

      .writer-save-btn {
        background: #000000;
        color: #ffffff;
        border: none;
        padding: 12px 24px;
        font-size: 14px;
        font-weight: 700;
        cursor: pointer;
        font-family: var(--font-primary);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: all 0.2s;
      }

      .writer-save-btn:hover {
        background: #333333;
      }

      .writer-footer-title {
        font-size: 48px;
        font-weight: 700;
        margin: 0;
        color: #000000;
        font-family: var(--font-primary);
      }

      .main-wrapper {
        display: none; /* Deprecated */
      }

      .codex-header {
        padding: var(--spacing-lg) var(--spacing-sm);
        border-bottom: var(--border-dotted);
        margin-bottom: var(--spacing-lg);
      }

      .codex-header h3 {
        font-size: var(--font-size-base);
        margin: 0;
      }

      .codex-search {
        width: 100%;
        padding: var(--spacing-xs) var(--spacing-sm);
        border: var(--border-width) solid var(--border-light);
        border-radius: 0;
        font-size: var(--font-size-xs);
        font-family: var(--font-primary);
        margin-bottom: var(--spacing-sm);
        background: var(--bg-primary);
      }

      .codex-search:focus {
        outline: none;
        border-color: var(--border-primary);
      }

      .codex-actions {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
        margin-bottom: var(--spacing-md);
      }

      .codex-btn {
        padding: var(--spacing-xs) var(--spacing-sm);
        background: transparent;
        border: var(--border-width) solid var(--border-light);
        border-radius: 0;
        cursor: pointer;
        font-size: var(--font-size-xs);
        transition: all 0.2s ease;
        text-align: left;
        font-family: var(--font-primary);
      }

      .codex-btn:hover {
        background: var(--bg-accent);
        color: var(--text-on-dark);
        border-color: var(--bg-accent);
      }

      .codex-content {
        flex: 1;
        overflow-y: auto;
        font-size: var(--font-size-xs);
      }

      .codex-category {
        margin-bottom: var(--spacing-lg);
      }

      .codex-category-header {
        padding-bottom: var(--spacing-sm);
        border-bottom: var(--border-dotted);
        font-size: var(--font-size-base);
        color: var(--text-primary);
        margin-bottom: var(--spacing-sm);
        cursor: pointer;
        user-select: none;
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        font-weight: normal;
      }

      .codex-category-arrow {
        font-size: var(--font-size-xs);
        transition: transform 0.2s;
      }

      .codex-category.collapsed .codex-category-arrow {
        transform: rotate(-90deg);
      }

      .codex-category-entries {
        list-style-type: none;
        margin: var(--spacing-md) 0;
      }

      .codex-category.collapsed .codex-category-entries {
        display: none;
      }

      .codex-entry {
        padding: var(--spacing-xs) 0;
        margin: var(--spacing-xs) 0;
        font-size: var(--font-size-xs);
        cursor: pointer;
        transition: opacity 0.2s ease;
      }

      .codex-entry:hover {
        opacity: 0.7;
      }

      .codex-entry.active {
        font-weight: bold;
      }

      /* Main codex grid styles */
      .codex-category-title {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        padding: 12px 0 6px 0;
      }

      .codex-types-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .codex-type-pill {
        padding: 6px 10px;
        background: var(--bg-primary);
        border: 1px solid var(--border-light);
        font-size: var(--font-size-xs);
        border-radius: 12px;
        cursor: pointer;
      }

      .codex-grid-container {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 20px;
        max-width: 1200px;
        margin: 0 auto;
        padding: 12px 20px 24px 20px;
      }

      .codex-category-title {
        grid-column: 1 / -1;
        padding: 6px 0 12px 0;
        border-top: 1px solid var(--border-light);
        margin-top: 18px;
      }

      .codex-types-row {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 12px;
      }

      .codex-entry-tile {
        display: flex;
        flex-direction: column;
        border-bottom: 1px solid #ccc;
        padding-bottom: 20px;
        margin-bottom: 20px;
        background: transparent;
      }

      /* Add-tile: visually matches the grid tile, with centered + button */
      .codex-entry-add {
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px dashed var(--border-light);
        background: rgba(0,0,0,0.02);
        /* match .codex-entry-image height */
        height: 300px;
        cursor: pointer;
        transition: background 0.15s, transform 0.08s;
      }

      .codex-entry-add:hover {
        background: rgba(0,0,0,0.04);
        transform: translateY(-2px);
      }

      .codex-entry-add-inner {
        text-align: center;
        font-size: 40px;
        line-height: 1;
        color: var(--text-primary);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }

      .codex-entry-add-label {
        font-size: 12px;
        opacity: 0.8;
        font-weight: 600;
      }

      .codex-entry-tile.active {
        outline: 1px solid rgba(0,0,0,0.06);
      }

      .codex-entry-image {
        width: 100%;
        height: 300px;
        object-fit: cover;
        background: #e6e6e6;
        margin-bottom: 15px;
      }

      .codex-entry-tag {
        font-size: 14px;
        font-weight: 700;
        margin-bottom: 10px;
        color: #666;
      }

      .codex-entry-name {
        font-size: 18px;
        margin-bottom: 10px;
        color: #333;
      }

      .codex-entry-desc {
        font-size: 14px;
        line-height: 1.5;
        color: #555;
        margin-bottom: 15px;
      }

      .codex-entry-link {
        font-size: 14px;
        color: var(--text-primary);
        text-decoration: none;
        font-style: italic;
      }

      .codex-entry-link:hover { text-decoration: underline; }

      /* Responsive */
      @media (max-width: 1024px) {
        .codex-grid-container { grid-template-columns: repeat(2, 1fr); }
      }
      @media (max-width: 600px) {
        .codex-grid-container { grid-template-columns: 1fr; }
      }

      /* Publisher view - continuous book on white background */
      #publisher-panel {
        background: var(--bg-primary);
        overflow-y: auto;
        padding: 30px 20px;
      }

      .publisher-view {
        background: var(--bg-primary);
        display: flex;
        justify-content: center;
        width: 100%;
        padding: 20px 0;
      }

      .publisher-inner {
        background: #ffffff;
        max-width: 820px;
        width: 100%;
        padding: 48px 56px;
        box-shadow: 0 6px 24px rgba(0,0,0,0.08);
        color: var(--text-primary);
        line-height: 1.6;
      }

      .publisher-title {
        font-size: 28px;
        margin: 0 0 24px 0;
        text-align: center;
      }

      .publisher-act-title { font-size: 20px; margin: 28px 0 12px 0; }
      .publisher-chapter-title { font-size: 18px; margin: 18px 0 10px 0; }
      .publisher-section-title { font-size: 16px; margin: 12px 0 6px 0; }
      .publisher-section-content { margin-bottom: 18px; }

      .codex-config-panel {
        width: 0;
        background: var(--bg-primary);
        border-right: var(--border-width) solid var(--border-light);
        display: flex;
        flex-direction: column;
        overflow: hidden;
        transition: width 0.3s ease;
        z-index: 3000;
        position: relative;
      }

      .codex-config-panel.expanded {
        width: 250px;
      }

      .codex-config-header {
        padding: var(--spacing-lg) var(--spacing-md);
        border-bottom: var(--border-dotted);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .codex-config-header h3 {
        margin: 0;
        font-size: var(--font-size-base);
        font-weight: normal;
        color: var(--text-primary);
      }

      .codex-config-collapse-btn {
        background: transparent;
        border: var(--border-width) solid var(--border-light);
        border-radius: 0;
        padding: var(--spacing-xs) var(--spacing-sm);
        cursor: pointer;
        font-size: var(--font-size-xs);
        transition: all 0.2s ease;
      }

      .codex-config-collapse-btn:hover {
        background: var(--bg-accent);
        color: var(--text-on-dark);
        border-color: var(--bg-accent);
      }

      .codex-config-content {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-md);
      }

      .codex-config-section {
        margin-bottom: var(--spacing-lg);
      }

      .codex-config-section label {
        display: block;
        margin-bottom: var(--spacing-sm);
        font-size: var(--font-size-xs);
        padding-bottom: var(--spacing-sm);
        border-bottom: var(--border-dotted);
        font-weight: normal;
      }

      .codex-categories-list {
        max-height: 400px;
        overflow-y: auto;
        border: var(--border-width) solid var(--border-light);
        border-radius: 0;
        padding: var(--spacing-sm);
        background: var(--bg-primary);
      }

      .codex-category-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--spacing-xs) 0;
        margin: var(--spacing-xs) 0;
        background: transparent;
        border-radius: 0;
        font-size: var(--font-size-xs);
      }

      .codex-category-item span {
        flex: 1;
        color: var(--text-primary);
      }

      .codex-category-delete-btn {
        background: transparent;
        border: none;
        cursor: pointer;
        font-size: var(--font-size-sm);
        padding: 2px 6px;
        transition: text-decoration 0.2s;
      }

      .codex-category-delete-btn:hover {
        text-decoration: line-through;
      }

      .codex-config-add-section {
        display: flex;
        gap: var(--spacing-xs);
      }

      .codex-config-add-section input {
        flex: 1;
      }

      .main-content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        background: var(--bg-primary);
        padding: var(--spacing-lg);
      }

      .container {
        width: 100%;
        max-width: none;
        margin: 0;
        padding: 0;
        overflow-y: auto;
        height: 100%;
      }

      h1 {
        color: var(--text-primary);
        margin: 0 0 var(--spacing-lg) 0;
        font-size: var(--font-size-xxl);
        font-weight: normal;
        letter-spacing: normal;
        line-height: 1.2;
      }

      /* Global Input & Textarea Styles */
      input, textarea, select {
        font-family: var(--font-primary);
        font-size: var(--font-size-sm);
        color: var(--text-primary);
        background: var(--bg-primary);
        border: var(--border-width) solid var(--border-light);
        border-radius: 0;
        padding: var(--spacing-xs) var(--spacing-sm);
        outline: none;
        transition: border-color 0.2s ease;
      }

      input:focus, textarea:focus, select:focus {
        border-color: var(--border-primary);
      }

      textarea {
        font-family: var(--font-primary);
        line-height: 1.5;
        resize: vertical;
      }

      /* Global Button Styles */
      button {
        font-family: var(--font-primary);
        font-size: var(--font-size-xs);
        font-weight: normal;
        letter-spacing: normal;
        text-transform: none;
        background: transparent;
        border: var(--border-width) solid var(--border-light);
        border-radius: 0;
        padding: var(--spacing-xs) var(--spacing-sm);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      button:hover {
        background: var(--bg-accent);
        color: var(--text-on-dark);
        border-color: var(--bg-accent);
      }

      button:disabled {
        opacity: 0.4;
        cursor: not-allowed;
      }

      button:disabled:hover {
        background: transparent;
        color: var(--text-primary);
        border-color: var(--border-light);
      }

      /* Breadcrumb Navigation */
      .breadcrumb {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        margin: 0;
        padding: 0;
        font-size: var(--font-size-base);
        color: var(--text-secondary);
      }

      .breadcrumb-item {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        cursor: pointer;
        transition: color 0.2s;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: normal;
      }

      .breadcrumb-item:hover {
        color: var(--text-primary);
      }

      .breadcrumb-item.active {
        color: var(--text-primary);
        font-weight: bold;
      }

      .breadcrumb-separator {
        color: var(--text-secondary);
        user-select: none;
      }

      .title-filter-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: var(--spacing-lg);
        margin-bottom: var(--spacing-lg);
        padding-bottom: var(--spacing-md);
        border-bottom: var(--border-dotted);
      }

      .title-section {
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        flex: 1 1 auto;
      }

      .language-selector {
        display: flex;
        align-items: center;
        gap: var(--spacing-xs);
        padding: var(--spacing-xs) var(--spacing-sm);
        border: var(--border-width) solid var(--border-light);
        background: var(--bg-primary);
        cursor: pointer;
        transition: border-color 0.2s;
        font-size: var(--font-size-xs);
      }

      .language-selector:hover {
        border-color: var(--border-primary);
      }

      .language-selector select {
        border: none;
        background: transparent;
        font-size: var(--font-size-xs);
        font-family: var(--font-primary);
        color: var(--text-primary);
        cursor: pointer;
        outline: none;
        padding: 0;
      }

      .language-selector select option {
        background: var(--bg-primary);
        color: var(--text-primary);
      }

      .filter-section {
        display: flex;
        align-items: center;
        gap: var(--spacing-sm);
        flex: 0 0 30%;
        max-width: 250px;
      }

      .filter-label {
        font-size: var(--font-size-xs);
        color: var(--text-primary);
        font-weight: normal;
        white-space: nowrap;
      }

      .filter-input-wrapper {
        position: relative;
        flex: 1;
        display: flex;
        align-items: center;
      }

      .filter-tag-input {
        width: 100%;
        padding: var(--spacing-sm) 30px var(--spacing-sm) var(--spacing-md);
        font-size: 14px;
        border: var(--border-width) solid var(--border-light);
        border-radius: 0;
        background: var(--bg-primary);
        color: var(--text-primary);
        outline: none;
        transition: border-color 0.2s;
        box-sizing: border-box;
      }

      .filter-tag-input:focus {
        border-color: var(--text-primary);
      }

      .filter-clear-icon {
        position: absolute;
        right: 4px;
        top: 50%;
        transform: translateY(-50%);
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 1.2em;
        cursor: pointer;
        padding: 0;
        width: 18px;
        height: 18px;
        display: none;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
        line-height: 1;
      }

      .filter-clear-icon:hover {
        background: var(--hover-bg);
        color: var(--text-primary);
      }

      .filter-toggle-btn {
        background: var(--bg-card-inner);
        color: var(--text-primary);
        border: 1px solid var(--border-primary);
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 0.9em;
        cursor: pointer;
        transition: all 0.2s;
        margin-left: 12px;
        vertical-align: middle;
      }

      .filter-toggle-btn:hover {
        background: var(--hover-bg-light);
        transform: translateY(-1px);
      }

      .filter-toggle-btn.active {
        background: var(--codex-primary);
        border-color: var(--codex-primary);
        color: white;
      }

      .filter-panel {
        background: var(--bg-secondary);
        border: 1px solid var(--border-primary);
        border-radius: 8px;
        padding: 12px 15px;
        margin-bottom: 20px;
        animation: slideDown 0.2s ease-out;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .filter-panel-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        font-size: 0.95em;
        color: var(--text-primary);
        font-weight: 500;
      }

      .filter-clear-btn {
        background: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border-primary);
        padding: 4px 10px;
        border-radius: 4px;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.2s;
      }

      .filter-clear-btn:hover {
        background: var(--hover-bg);
        color: var(--text-primary);
      }

      .filter-input-container {
        position: relative;
        margin-bottom: 12px;
      }

      .filter-tag-input {
        width: 100%;
        padding: 8px 12px;
        font-size: 0.9em;
        border: 2px solid var(--border-primary);
        border-radius: 6px;
        background: var(--bg-card-inner);
        color: var(--text-primary);
        outline: none;
        transition: border-color 0.2s;
        box-sizing: border-box;
      }

      .filter-tag-input:focus {
        border-color: var(--codex-primary);
      }

      .filter-autocomplete {
        position: absolute;
        top: calc(100% + 2px);
        left: 0;
        right: 0;
        background: var(--bg-card-inner);
        border: 2px solid var(--codex-primary);
        border-radius: 6px;
        max-height: 250px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      }

      .filter-autocomplete-item {
        padding: 8px 12px;
        cursor: pointer;
        font-size: 0.9em;
        color: var(--text-primary);
        transition: background 0.2s;
      }

      .filter-autocomplete-item:hover,
      .filter-autocomplete-item.selected {
        background: var(--hover-bg);
      }

      .filter-autocomplete-item.highlighted {
        background: var(--hover-bg-light);
      }

      .filter-selected-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-bottom: 12px;
        padding: 0 16px;
      }

      .filter-selected-tag {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: var(--codex-primary);
        color: white;
        border: none;
        padding: 4px 8px;
        border-radius: 16px;
        font-size: 0.8em;
        font-weight: 500;
        user-select: none;
        animation: slideIn 0.2s ease-out;
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: scale(0.8);
        }
        to {
          opacity: 1;
          transform: scale(1);
        }
      }

      .filter-selected-tag-remove {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 1.1em;
        line-height: 1;
        padding: 0;
        width: 16px;
        height: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: background 0.2s;
      }

      .filter-selected-tag-remove:hover {
        background: rgba(255, 255, 255, 0.2);
      }

      .filter-tags-container {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .filter-tag {
        background: var(--bg-card-inner);
        color: var(--text-primary);
        border: 1px solid var(--border-primary);
        padding: 6px 12px;
        border-radius: 16px;
        font-size: 0.85em;
        cursor: pointer;
        transition: all 0.2s;
        user-select: none;
      }

      .filter-tag:hover {
        background: var(--hover-bg-light);
        transform: translateY(-1px);
      }

      .filter-tag.selected {
        background: var(--codex-primary);
        border-color: var(--codex-primary);
        color: white;
        font-weight: 500;
      }

      .act-section.filtered-hidden,
      .chapter-card.filtered-hidden,
      .chapter-section.filtered-hidden {
        display: none;
      }

      .structure-outline {
        font-family: var(--font-primary);
        line-height: 1.6;
        background: #ffffff;
        padding: var(--spacing-lg);
      }

      .structure-item {
        display: flex;
        align-items: flex-start;
        gap: var(--spacing-md);
        padding: var(--spacing-xs) 0;
        border-bottom: 1px solid transparent;
        transition: background 0.2s ease;
      }

      .structure-item:hover {
        background: var(--bg-hover);
      }

      .structure-number {
        flex-shrink: 0;
        font-weight: bold;
        min-width: 50px;
        text-align: right;
        color: var(--text-primary);
        font-size: var(--font-size-sm);
      }

      .structure-content {
        flex: 1;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--spacing-sm);
        min-width: 0;
      }

      .structure-title-row {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: var(--spacing-sm);
        width: 100%;
      }

      .structure-title {
        flex: 1;
        min-width: 0;
        word-wrap: break-word;
        cursor: pointer;
      }

      .act-item {
        margin-bottom: var(--spacing-md);
        padding: var(--spacing-md) 0 var(--spacing-sm);
        border-bottom: 1px solid var(--border-light);
      }

      .act-item .structure-number {
        font-size: var(--font-size-lg);
        font-weight: 600;
        font-family: var(--font-primary);
        letter-spacing: 0.05em;
      }

      .act-item .structure-title {
        font-size: var(--font-size-lg);
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.6px;
      }

      .chapter-number {
        color: #000000;
        font-weight: 700;
        text-align: right;
        padding-top: 0;
        font-family: var(--font-primary);
        letter-spacing: 0.05em;
        font-size: var(--font-size-base);
        line-height: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: flex-end;
      }

      .chapter-write-btn {
        background: transparent;
        border: 1px solid #000000;
        color: #000000;
        padding: 2px 6px;
        font-size: 14px;
        cursor: pointer;
        border-radius: 3px;
        transition: all 0.2s;
        line-height: 1;
      }

      .chapter-write-btn:hover {
        background: #000000;
        color: #ffffff;
      }

      .chapter-title {
        font-weight: 700;
        font-size: var(--font-size-base);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.3;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
      }

      .chapter-sections {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .section-row {
        display: flex;
        gap: var(--spacing-md);
        align-items: flex-start;
        padding: var(--spacing-xs) 0;
        margin-bottom: 40px;
      }

      .section-row.empty {
        color: var(--text-secondary);
        font-style: italic;
        font-size: var(--font-size-xs);
      }

      .section-number {
        font-weight: 500;
        color: var(--text-secondary);
        font-family: var(--font-primary);
        letter-spacing: 0.05em;
        font-size: var(--font-size-xs);
        min-width: 50px;
        text-align: left;
      }

      .section-content {
        flex: 1;
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: var(--spacing-xs);
      }

      .section-tags {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
      }

      .structure-action-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: var(--font-size-xs);
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 3px;
        transition: all 0.2s;
        white-space: nowrap;
        flex-shrink: 0;
        opacity: 0;
      }

      .chapter-collapse-btn {
        opacity: 1;
        margin-right: 4px;
      }

      .structure-item:hover .structure-action-btn {
        opacity: 1;
      }

      .structure-action-btn:hover {
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      .chapters-grid {
        display: flex;
        flex-direction: column;
        gap: 0;
      }

      .chapter-row {
        display: grid;
        grid-template-columns: 90px 1fr 2fr;
        gap: var(--spacing-lg);
        padding: var(--spacing-md) 0;
        border-top: 1px solid var(--border-light);
        align-items: flex-start;
      }

      .chapter-row.collapsed .chapter-sections {
        display: none;
      }

      .section-summary {
        color: var(--text-primary);
        font-size: var(--font-size-sm);
        line-height: 1.5;
        margin: 0;
        font-style: normal;
      }



      .section-tags {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
        align-items: center;
      }

      .section-tag {
        background: #f3f3f3;
        color: #000000;
        padding: 2px 6px 2px 8px;
        border-radius: 3px;
        font-size: var(--font-size-xs);
        border: 1px solid var(--border-light);
        font-style: italic;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .tag-remove-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        font-size: 14px;
        line-height: 1;
        cursor: pointer;
        padding: 0 2px;
        margin: 0;
        transition: color 0.2s;
      }

      .tag-remove-btn:hover {
        color: var(--text-primary);
      }

      .tag-add-btn {
        background: transparent;
        border: 1px dashed var(--border-secondary);
        color: var(--text-secondary);
        font-size: var(--font-size-xs);
        padding: 2px 8px;
        border-radius: 3px;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
      }

      .tag-add-btn:hover {
        border-color: var(--border-primary);
        color: var(--text-primary);
        background: var(--bg-secondary);
      }

      .act-section {
        margin-bottom: 40px;
        page-break-inside: avoid;
      }

      .add-act-section {
        text-align: center;
        margin-top: 20px;
        padding: 20px;
      }

      .add-act-btn {
        background: var(--bg-card-inner);
        color: var(--text-primary);
        border: 2px solid var(--border-primary);
        padding: 12px 30px;
        border-radius: var(--border-radius-lg);
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      }

      .add-act-btn:hover {
        background: var(--hover-bg-light);
        color: var(--text-primary);
        transform: scale(1.05);
      }

      .add-act-btn:active {
        transform: scale(0.98);
      }

      /* Drag and drop support */
      .chapter-section.dragging {
        opacity: 0.5;
        cursor: grabbing;
      }

      .chapter-section.drag-over {
        background: var(--bg-hover);
      }

      .empty-state {
        color: var(--text-secondary);
        font-style: italic;
        padding: var(--spacing-md);
        text-align: center;
      }

      .section-tags {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-xs);
        margin-top: var(--spacing-xs);
      }

      .empty-state {
        text-align: center;
        color: var(--text-primary);
        font-size: var(--font-size-sm);
        padding: var(--spacing-lg);
        background: var(--bg-primary);
        border-radius: 0;
        border: var(--border-dotted);
      }

      /* Modal styles */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 5000;
      }

      .modal-overlay.active {
        display: flex;
      }

      .modal {
        background: var(--bg-primary);
        border-radius: 0;
        padding: var(--spacing-lg);
        min-width: 300px;
        border: var(--border-width) solid var(--border-primary);
        box-shadow: none;
      }

      .modal-title {
        font-size: var(--font-size-lg);
        color: var(--text-primary);
        margin-bottom: var(--spacing-md);
        font-weight: normal;
      }

      .modal-input {
        width: 100%;
        padding: var(--spacing-xs) var(--spacing-sm);
        font-size: var(--font-size-sm);
        border: var(--border-width) dotted var(--border-light);
        border-radius: 0;
        margin-bottom: var(--spacing-md);
        box-sizing: border-box;
      }

      .modal-input:focus {
        outline: none;
        border-color: var(--border-primary);
        border-style: solid;
      }

      .modal-buttons {
        display: flex;
        gap: var(--spacing-xs);
        justify-content: flex-end;
      }

      .modal-btn {
        padding: var(--spacing-xs) var(--spacing-sm);
        border: var(--border-width) solid var(--border-light);
        border-radius: 0;
        font-size: var(--font-size-xs);
        cursor: pointer;
        transition: all 0.2s;
        background: transparent;
        font-weight: normal;
      }

      .modal-btn-primary {
        background: transparent;
        color: var(--text-primary);
        border-color: var(--border-primary);
      }

      .modal-btn-primary:hover {
        background: var(--bg-accent);
        color: var(--text-on-dark);
        border-color: var(--bg-accent);
      }

      .modal-btn-secondary {
        background: transparent;
        color: var(--text-primary);
      }

      .modal-btn-secondary:hover {
        text-decoration: line-through;
      }
    </style>
  </head>
  <body>
    <div class="app-layout">
      <!-- Breadcrumb Navigation (Always Visible) -->
      <div class="breadcrumb-container">
          <nav class="breadcrumb">
          <span class="breadcrumb-item" data-section="info">Info</span>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-item" data-section="codex">Codex</span>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-item active" data-section="structure">Structure</span>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-item" data-section="writer">Writer</span>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-item" data-section="ia">IA</span>
          <span class="breadcrumb-separator">/</span>
          <span class="breadcrumb-item" data-section="publish">Publish</span>
        </nav>
      </div>

      <!-- Main Application Container -->
      <div class="app-container">
        <!-- Shared Codex Panel (Always Visible) -->
        <div class="codex-panel">
          <div class="codex-header">
            <h3>Codex</h3>
          </div>
          <div class="codex-content" id="codex-content"></div>
          <div class="codex-actions">
            <button class="codex-btn" id="codex-add-btn" title="Add New Entry">New Entry</button>
            <button class="codex-btn" id="codex-config-btn" title="Configure Categories">Config</button>
          </div>
          <input type="text" class="codex-search" id="codex-search" placeholder="Filter...">
        </div>

        <!-- Panels Container -->
        <div class="panels-container">
          <!-- Info Panel -->
          <div id="info-panel" class="app-panel">
            <div class="info-panel-content">
              <h1 class="info-book-title" id="info-book-title">Book Title</h1>

              <div class="info-section">
                <h3 class="info-section-title">Basic Information</h3>
                <div class="info-section-content">
                  <div class="info-label">Title</div>
                  <input type="text" class="info-editable-field" id="info-title" placeholder="Book title">

                  <div class="info-label">Subtitle</div>
                  <input type="text" class="info-editable-field" id="info-subtitle" placeholder="Book subtitle (optional)">

                  <div class="info-label">Author</div>
                  <input type="text" class="info-editable-field" id="info-author" placeholder="Author name">

                  <div class="info-label">Genre</div>
                  <input type="text" class="info-editable-field" id="info-genre" placeholder="Genre">

                  <div class="info-label">Language</div>
                  <select class="info-editable-field" id="info-language-selector">
                    <option value="pt-BR">ðŸ‡§ðŸ‡· PortuguÃªs (Brasil)</option>
                    <option value="en-US">ðŸ‡ºðŸ‡¸ English (United States)</option>
                  </select>

                  <div class="info-label">Created</div>
                  <input type="date" class="info-editable-field" id="info-created">

                  <div class="info-label">Last Modified</div>
                  <div class="info-value" id="info-modified">â€”</div>
                </div>
              </div>

              <div class="info-section">
                <h3 class="info-section-title">Synopsis</h3>
                <div class="info-section-content" style="grid-template-columns: 1fr;">
                  <textarea class="info-textarea" id="info-synopsis" placeholder="Write a brief synopsis of your book..."></textarea>
                </div>
              </div>

              <div class="info-section">
                <h3 class="info-section-title">Statistics</h3>
                <div class="info-stats-grid">
                  <div class="info-stat-item">
                    <div class="info-stat-number" id="stat-acts">0</div>
                    <div class="info-stat-label">Acts</div>
                  </div>
                  <div class="info-stat-item">
                    <div class="info-stat-number" id="stat-chapters">0</div>
                    <div class="info-stat-label">Chapters</div>
                  </div>
                  <div class="info-stat-item">
                    <div class="info-stat-number" id="stat-sections">0</div>
                    <div class="info-stat-label">Sections</div>
                  </div>
                  <div class="info-stat-item">
                    <div class="info-stat-number" id="stat-words">0</div>
                    <div class="info-stat-label">Total Words</div>
                  </div>
                  <div class="info-stat-item">
                    <div class="info-stat-number" id="stat-characters">0</div>
                    <div class="info-stat-label">Characters</div>
                  </div>
                  <div class="info-stat-item">
                    <div class="info-stat-number" id="stat-codex">0</div>
                    <div class="info-stat-label">Codex Entries</div>
                  </div>
                </div>
              </div>

              <div class="info-section">
                <h3 class="info-section-title">Notes</h3>
                <div class="info-section-content" style="grid-template-columns: 1fr;">
                  <textarea class="info-textarea" id="info-notes" placeholder="Additional notes, ideas, or reminders..."></textarea>
                </div>
              </div>
            </div>
          </div>

          <!-- Codex Main Panel (new) -->
          <div id="codex-main-panel" class="app-panel">
            <div class="container">
              <div style="display: flex; align-items: center; justify-content: space-between; gap: 12px; margin-bottom: 16px;">
                <h2 style="margin:0;">Codex</h2>
                <div style="display:flex; gap:8px; align-items:center;">
                  <button class="codex-btn" id="codex-main-new">New Entry</button>
                  <input type="text" id="codex-main-search" class="codex-search" placeholder="Filter..." style="max-width:240px;" />
                </div>
              </div>

              <div id="codex-main-content" style="display:block;">
                <div id="codex-main-list" style="width:100%; overflow-y:auto; padding-right:6px;">
                  <!-- Codex list will be rendered here (large view) -->
                </div>
              </div>
            </div>
          </div>

          <!-- Structure Panel -->
          <div id="structure-panel" class="app-panel active">
            <div class="container">
              <!-- Title and Filter Row -->
              <div class="title-filter-row">
                <div class="title-section">
                  <h1 id="book-title">ðŸ“š Book Structure</h1>
                </div>

                <div class="filter-section">
                  <label class="filter-label">Filter:</label>
                  <div class="filter-input-wrapper">
                    <input
                      type="text"
                      id="filter-tag-input"
                      class="filter-tag-input"
                      placeholder="Type to search tags..."
                      autocomplete="off"
                    />
                    <button id="filter-clear-btn" class="filter-clear-icon" title="Clear filters" style="display: none;">Ã—</button>
                    <div id="filter-autocomplete" class="filter-autocomplete" style="display: none;">
                      <!-- Autocomplete suggestions will appear here -->
                    </div>
                  </div>
                </div>
              </div>

              <!-- Selected Tags -->
              <div id="filter-selected-tags" class="filter-selected-tags" style="display: none;">
                <!-- Selected tags will be displayed here -->
              </div>

              <div id="book-structure"></div>
            </div>
          </div>

          <!-- Writer Panel -->
          <div id="writer-panel" class="app-panel">
            <div class="writer-container">
              <div class="writer-grid">
                <h1 class="writer-title" contenteditable="true">Euismod tincidunt ut laoreet dolore</h1>
                <div class="writer-number">02</div>
              </div>
              
              <div class="writer-sections">
                <div class="writer-section">
                  <div class="section-summary">
                    In quis enim sit magna molestiae, quae laudantia aperiet faciunt facilisi.
                  </div>
                  <div class="section-content">
                    <p contenteditable="true">Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex ea commodo consequat.</p>
                    <p contenteditable="true">Duis autem vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent luptatum zzril delenit augue duis dolore te feugait nulla facilisi.</p>
                  </div>
                </div>
                
                <div class="writer-section">
                  <div class="section-summary">
                    Duis autem vel eum dolore / 2020
                  </div>
                  <div class="section-content">
                    <p contenteditable="true">Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat.</p>
                    <p contenteditable="true">Duis autem vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent luptatum zzril delenit augue duis dolore te feugait nulla facilisi.</p>
                    <p contenteditable="true">Lorem ipsum dolor sit amet, cons ectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat. Ut wisi enim ad minim veniam, quis nostrud exerci tation ullamcorper suscipit lobortis nisl ut aliquip ex ea commodo consequat.</p>
                  </div>
                </div>
                
                <div class="writer-section">
                  <div class="section-summary">
                    Duska Expa 1997 - 2010
                  </div>
                  <div class="section-content">
                    <p contenteditable="true">Lorem ipsum dolor sit amet, consectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat.</p>
                    <p contenteditable="true">Duis autem vel eum iriure dolor in hendrerit in vulputate velit esse molestie consequat, vel illum dolore eu feugiat nulla facilisis at vero eros et accumsan et iusto odio dignissim qui blandit praesent luptatum zzril delenit augue duis dolore te feugait nulla facilisi. Lorem ipsum dolor sit amet, cons ectetuer adipiscing elit, sed diam nonummy nibh euismod tincidunt ut laoreet dolore magna aliquam erat volutpat.</p>
                  </div>
                </div>
              </div>
              
              <div class="writer-footer">
                <h2 class="writer-footer-title">Osaka</h2>
              </div>
            </div>
          </div>

          <!-- AI Panel -->
          <div id="ai-panel" class="app-panel">
            <div class="container">
              <h2>AI Assistant</h2>
              <p>AI panel will be integrated here...</p>
            </div>
          </div>

          <!-- Publisher Panel -->
          <div id="publisher-panel" class="app-panel">
            <!-- Publisher continuous book view (rendered by js/publisher.js) -->
            <!-- initially empty; Publisher.render() will populate -->
          </div>
        </div> <!-- .panels-container -->
      </div> <!-- .app-container -->

      <div class="main-wrapper">
      <!-- This is now deprecated, kept for compatibility -->
      <div class="codex-panel" style="display: none;">
        <div class="codex-header">
          <h3>Codex</h3>
        </div>
        <div class="codex-content" id="codex-content-old"></div>
        <div class="codex-actions">
          <button class="codex-btn" id="codex-add-btn-old" title="Add New Entry">New Entry</button>
          <button class="codex-btn" id="codex-config-btn-old" title="Configure Categories">Config</button>
        </div>
        <input type="text" class="codex-search" id="codex-search-old" placeholder="Filter...">
      </div>

      <!-- Codex Config Panel (Expandable) -->
      <div class="codex-config-panel" id="codex-config-panel">
        <div class="codex-config-header">
          <h3>Configure Categories</h3>
          <button class="codex-config-collapse-btn" id="codex-config-collapse">â—€</button>
        </div>
        <div class="codex-config-content">
          <div class="codex-config-section">
            <label>Categories</label>
            <div class="codex-categories-list" id="codex-categories-list">
              <!-- Categories will be listed here -->
            </div>
          </div>
          <div class="codex-config-section">
            <label>Add New Category</label>
            <div class="codex-config-add-section">
              <input type="text" class="modal-input" id="codex-new-category" placeholder="New category name..." style="margin-bottom: 0;">
              <button class="codex-btn" id="codex-add-category" style="flex: none; padding: 8px 16px;">Add</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Codex Entry Editor Panel (Expandable) -->
      <div class="codex-config-panel" id="codex-entry-panel">
        <div class="codex-config-header">
          <h3 id="codex-entry-panel-title">Edit Entry</h3>
          <button class="codex-config-collapse-btn" id="codex-entry-collapse">â—€</button>
        </div>
        <div class="codex-config-content">
          <div class="codex-config-section">
            <label>Entry Name</label>
            <input type="text" class="modal-input" id="codex-entry-panel-name" placeholder="Entry name..." style="margin-bottom: 0;">
          </div>

          <div class="codex-config-section">
            <label>Category</label>
            <select id="codex-entry-panel-category" class="modal-input" style="cursor: pointer; margin-bottom: 0;">
              <!-- Categories will be populated dynamically -->
            </select>
          </div>

          <div class="codex-config-section">
            <label>Tags</label>
            <div id="codex-entry-panel-tags" style="min-height: 30px; padding: 6px; border: 1px solid var(--border-tertiary); border-radius: 6px; background: var(--bg-card-inner); display: flex; flex-wrap: wrap; gap: 4px; align-items: center;">
              <!-- Tags will be rendered here -->
            </div>
          </div>

          <div class="codex-config-section">
            <label>Description</label>
            <textarea id="codex-entry-panel-description" class="modal-input" rows="10" placeholder="Enter description..." style="resize: vertical; font-family: inherit; margin-bottom: 0;"></textarea>
          </div>

          <div class="codex-config-section">
            <button class="codex-btn" id="codex-entry-panel-delete" style="width: 100%; background: var(--color-danger); color: white; border: 1px solid var(--color-danger); display: none;">
              Delete Entry
            </button>
          </div>

          <div class="codex-config-section" style="display: flex; gap: 8px;">
            <button class="codex-btn" id="codex-entry-panel-find" style="flex: 1; background: var(--codex-primary); color: white; border: 1px solid var(--codex-primary);">
              ðŸ” Find
            </button>
            <button class="codex-btn" id="codex-entry-panel-cancel" style="flex: 1;">
              Cancel
            </button>
            <button class="codex-btn" id="codex-entry-panel-save" style="flex: 1; background: var(--bg-card-inner); border: 1px solid var(--border-primary);">
              Save Entry
            </button>
          </div>
        </div>
      </div>

      <!-- AI Assistant Panel -->
      <div id="ai-panel" class="ai-panel" style="display: none;">
        <div class="ai-panel-header">
          <h2>AI Assistant Configuration</h2>
        </div>

        <div class="ai-panel-content">
          <!-- API Configuration Section -->
          <div class="ai-config-section">
            <h3>API Configuration</h3>

            <!-- API Connection Group -->
            <div class="ai-api-connection-group">
              <div class="ai-config-field">
                <label for="ai-api-url">API URL (Base URL)</label>
                <div style="display: flex; gap: 8px;">
                  <input type="text" id="ai-api-url" class="ai-input" style="flex: 1;" placeholder="https://api.openai.com/v1 or http://192.168.68.57:3000">
                  <button class="ai-btn ai-btn-secondary" id="ai-test-btn" style="flex: none; padding: 8px 16px;">ðŸ” Test</button>
                </div>
              </div>

              <div class="ai-config-field">
                <label for="ai-api-key">API Key</label>
                <input type="password" id="ai-api-key" class="ai-input" placeholder="sk-...">
              </div>
            </div>

            <div class="ai-config-field">
              <label for="ai-model">Model</label>
              <div style="display: flex; gap: 8px;">
                <select id="ai-model" class="ai-input" style="flex: 1; cursor: pointer;">
                  <option value="">Select a model...</option>
                  <option value="gpt-4">gpt-4</option>
                  <option value="gpt-4-turbo">gpt-4-turbo</option>
                  <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
                </select>
                <button class="ai-btn ai-btn-secondary" id="ai-fetch-models-btn" style="flex: none; padding: 8px 16px;">ðŸ”„ Get Models</button>
              </div>
            </div>

            <div class="ai-config-field">
              <label for="ai-temperature">Temperature (0-2)</label>
              <input type="number" id="ai-temperature" class="ai-input" min="0" max="2" step="0.1" value="0.7">
            </div>

            <div class="ai-config-field">
              <label for="ai-max-tokens">Max Tokens</label>
              <input type="number" id="ai-max-tokens" class="ai-input" min="1" max="8000" step="1" value="2000">
            </div>

            <div class="ai-config-buttons">
              <button class="ai-btn ai-btn-primary" id="ai-save-config-btn">ðŸ’¾ Save Config</button>
            </div>

            <!-- Feedback Message Area -->
            <div id="ai-config-message" class="ai-config-message" style="display: none;"></div>
          </div>

          <!-- Prompts Section -->
          <div class="ai-prompts-section">
            <h3>Available Actions</h3>
            <div class="ai-prompts-list" id="ai-prompts-list">
              <!-- Prompts will be loaded dynamically -->
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="main-content-area">
        <div class="container">
          <!-- Title and Filter Row -->
          <div class="title-filter-row">
            <div class="title-section">
              <h1 id="book-title">ðŸ“š Book Structure</h1>
            </div>

            <div class="filter-section">
              <label class="filter-label">Filter:</label>
              <div class="filter-input-wrapper">
                <input
                  type="text"
                  id="filter-tag-input"
                  class="filter-tag-input"
                  placeholder="Type to search tags..."
                  autocomplete="off"
                />
                <button id="filter-clear-btn" class="filter-clear-icon" title="Clear filters" style="display: none;">Ã—</button>
                <div id="filter-autocomplete" class="filter-autocomplete" style="display: none;">
                  <!-- Autocomplete suggestions will appear here -->
                </div>
              </div>
            </div>
          </div>

          <!-- Selected Tags -->
          <div id="filter-selected-tags" class="filter-selected-tags" style="display: none;">
            <!-- Selected tags will be displayed here -->
          </div>

          <div id="book-structure"></div>
        </div>
      </div>
      </div> <!-- .main-wrapper -->
    </div>

    <!-- Modal for adding chapter -->
    <div id="modal-overlay" class="modal-overlay">
      <div class="modal">
        <h3 class="modal-title">Add New Chapter</h3>
        <input type="text" id="modal-input" class="modal-input" placeholder="Enter chapter title...">
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" id="modal-cancel">Cancel</button>
          <button class="modal-btn modal-btn-primary" id="modal-confirm">Add Chapter</button>
        </div>
      </div>
    </div>

    <!-- Modal for chapter properties -->
    <div id="chapter-properties-modal" class="modal-overlay">
      <div class="modal" style="min-width: 500px;">
        <h3 class="modal-title">Chapter Properties</h3>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Chapter Title</label>
          <input type="text" id="chapter-prop-title" class="modal-input" placeholder="Chapter title...">
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="chapter-prop-numbering" style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-weight: 600; color: #333;">Numbering</span>
          </label>
          <div style="margin-left: 28px; margin-top: 5px; font-size: 0.85em; color: #666;">
            If off, this chapter won't have a number (e.g., Prologue, Appendix)
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
            <input type="checkbox" id="chapter-prop-visible" style="width: 18px; height: 18px; cursor: pointer;">
            <span style="font-weight: 600; color: #333;">Visible in Final Text</span>
          </label>
          <div style="margin-left: 28px; margin-top: 5px; font-size: 0.85em; color: #666;">
            If off, this chapter will be excluded from final compilation
          </div>
        </div>

        <div style="border-top: 1px solid #ddd; padding-top: 15px; margin-bottom: 15px;">
          <button class="modal-btn" id="chapter-prop-delete" style="background: #dc3545; color: white; width: 100%;">
            Delete Chapter
          </button>
          <div style="margin-top: 5px; font-size: 0.8em; color: #999; text-align: center;">
            This action cannot be undone
          </div>
        </div>

        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" id="chapter-prop-cancel">Cancel</button>
          <button class="modal-btn modal-btn-primary" id="chapter-prop-save">Save Changes</button>
        </div>
      </div>
    </div>

    <!-- Modal for adding codex entry -->
    <div id="codex-entry-modal" class="modal-overlay">
      <div class="modal" style="min-width: 500px;">
        <h3 class="modal-title" id="codex-entry-modal-title">Add Codex Entry</h3>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Entry Name</label>
          <input type="text" id="codex-entry-name" class="modal-input" placeholder="Enter entry name...">
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Category</label>
          <select id="codex-entry-category" class="modal-input" style="cursor: pointer;">
            <!-- Categories will be populated dynamically -->
          </select>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Tags</label>
          <div id="codex-entry-tags" style="min-height: 30px; padding: 6px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; display: flex; flex-wrap: wrap; gap: 4px; align-items: center;">
            <!-- Tags will be rendered here -->
          </div>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Description</label>
          <textarea id="codex-entry-description" class="modal-input" rows="6" placeholder="Enter description..." style="resize: vertical; font-family: inherit;"></textarea>
        </div>

        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" id="codex-entry-delete" style="display: none; margin-right: auto; background: #dc3545; color: white; border: 1px solid #c82333;">Delete</button>
          <button class="modal-btn modal-btn-secondary" id="codex-entry-cancel">Cancel</button>
          <button class="modal-btn modal-btn-primary" id="codex-entry-save">Add Entry</button>
        </div>
      </div>
    </div>

    <!-- AI Prompt Editor Modal -->
    <div id="ai-prompt-modal" class="modal-overlay">
      <div class="modal" style="min-width: 600px; max-width: 800px;">
        <h3 class="modal-title">Edit Prompt</h3>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Prompt Name</label>
          <input type="text" id="ai-prompt-name" class="modal-input" placeholder="Prompt name..." readonly>
        </div>

        <div style="margin-bottom: 15px;">
          <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #333;">Template</label>
          <div style="font-size: 0.8em; color: #666; margin-bottom: 5px;">
            Use variables: {context}, {text}, {instructions}, {pov}, {length}
          </div>
          <textarea id="ai-prompt-template" class="modal-input" rows="12" placeholder="Enter prompt template..." style="resize: vertical; font-family: monospace; font-size: 0.9em;"></textarea>
        </div>

        <div class="modal-buttons">
          <button class="modal-btn modal-btn-secondary" id="ai-prompt-reset" style="margin-right: auto; background: #dc3545; color: white; border: 1px solid #c82333;">Reset to Default</button>
          <button class="modal-btn modal-btn-secondary" id="ai-prompt-cancel">Cancel</button>
          <button class="modal-btn modal-btn-primary" id="ai-prompt-save">Save Prompt</button>
        </div>
      </div>
    </div>

    <!-- Chapter Editor -->
    <div id="chapter-editor" class="chapter-editor" style="display: none;">
      <div class="editor-header">
        <button class="editor-close-btn" id="editor-close">â—€</button>
        <div class="editor-title">
          <h2 id="editor-chapter-title"></h2>
          <span id="editor-breadcrumb"></span>
        </div>
      </div>

      <div class="editor-content">
        <div class="editor-main" id="editor-main">
          <!-- Sections with side notes will be rendered here -->
        </div>
      </div>
    </div>

    <style>
      /* Chapter Editor Styles */
      .chapter-editor {
        position: fixed;
        top: 60px;
        left: 160px;
        right: 0;
        bottom: 0;
        background: var(--bg-primary);
        z-index: 50;
        display: flex;
        flex-direction: column;
        transition: left 0.3s ease;
      }

      /* Adjust editor when config panel is open */
      body:has(#codex-config-panel.expanded) .chapter-editor {
        left: 410px;
      }

      /* Adjust editor when entry panel is open */
      body:has(#codex-entry-panel.expanded) .chapter-editor {
        left: 410px;
      }

      /* Adjust editor when both panels are open */
      body:has(#codex-config-panel.expanded):has(#codex-entry-panel.expanded) .chapter-editor {
        left: 660px;
      }

      /* Hide body overflow when editor is open */
      body:has(.chapter-editor[style*="display: flex"]) {
        overflow: hidden;
      }

      .editor-header {
        background: var(--bg-primary);
        color: var(--text-primary);
        padding: var(--spacing-md) var(--spacing-lg);
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: none;
        border-bottom: var(--border-dotted);
        gap: var(--spacing-md);
      }

      .editor-title {
        flex: 1;
      }

      .editor-title h2 {
        margin: 0;
        font-size: var(--font-size-lg);
        font-weight: normal;
      }

      .editor-breadcrumb {
        font-size: var(--font-size-xs);
        opacity: 0.7;
        margin-top: var(--spacing-xs);
        display: block;
      }

      .editor-close-btn {
        background: transparent;
        border: var(--border-width) solid var(--border-light);
        color: var(--text-primary);
        font-size: var(--font-size-base);
        width: 28px;
        height: 28px;
        border-radius: 0;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }

      .editor-close-btn:hover {
        text-decoration: line-through;
      }

      .editor-content {
        flex: 1;
        overflow-y: auto;
        background: var(--bg-primary);
      }

      .editor-main {
        width: 100%;
        padding: var(--spacing-lg);
      }

      .section-editor-block {
        background: var(--bg-primary);
        border-radius: 0;
        box-shadow: none;
        margin-bottom: var(--spacing-xs);
        overflow: visible;
        display: flex;
        flex-direction: row;
        border: 1px solid #D4D4D4;
      }

      .section-left-column {
        flex: 0 0 80%;
        display: flex;
        flex-direction: column;
      }

      .section-body {
        display: flex;
        flex-direction: row;
        flex: 1;
      }

      .section-main-content {
        flex: 1;
      }

      .section-sidenotes {
        flex: 0 0 20%;
        background: #F0EFEB;
        border-left: 1px solid #D4D4D4;
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .section-note {
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: 6px;
        padding: 8px;
        font-size: 0.8em;
        line-height: 1.5;
        outline: none;
        min-height: 50px;
        resize: vertical;
        font-family: var(--font-editor);
      }

      .section-note:focus {
        border-color: var(--border-primary);
        box-shadow: 0 0 0 2px rgba(40, 54, 24, 0.2);
      }

      .add-note-btn {
        background: var(--bg-card-inner);
        color: var(--text-primary);
        border: 1px solid var(--border-primary);
        padding: var(--spacing-sm) var(--spacing-lg);
        border-radius: var(--border-radius);
        font-size: 0.75em;
        cursor: pointer;
        transition: background 0.2s;
      }

      .add-note-btn:hover {
        background: var(--hover-bg);
      }

      .section-info-header {
        background: var(--bg-section-header);
        color: var(--text-primary);
        padding: var(--spacing-xs) var(--spacing-xs);
        border-bottom: 2px solid var(--border-primary);
      }

      .section-header-top {
        display: flex;
        align-items: center;
        gap: 2px;
        margin-bottom: 2px;
      }

      .section-collapse-btn {
        background: rgba(255,255,255,0.2);
        border: none;
        color: white;
        width: 22px;
        height: 22px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.75em;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
        flex-shrink: 0;
      }

      .section-collapse-btn:hover {
        background: #D4D4D4;
      }

      .section-info-label {
        font-size: 0.7em;
        font-weight: 600;
        color: var(--text-primary);
        text-transform: uppercase;
        letter-spacing: 1.5px;
        flex: 1;
      }

      .section-controls {
        display: flex;
        gap: var(--spacing-sm);
      }

      .section-config-btn,
      .section-delete-btn {
        background: transparent;
        border: 1px solid var(--border-primary);
        color: var(--text-primary);
        width: var(--btn-size-sm);
        height: var(--btn-size-sm);
        border-radius: var(--border-radius);
        cursor: pointer;
        font-size: 0.75em;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background 0.2s;
      }

      .section-config-btn:hover {
        background: var(--hover-bg);
      }

      .section-delete-btn:hover {
        background: var(--hover-bg);
        color: var(--color-danger);
      }

      .section-editor-block.collapsed .section-info-summary,
      .section-editor-block.collapsed .section-info-tags,
      .section-editor-block.collapsed .section-main-content,
      .section-editor-block.collapsed .section-sidenotes {
        display: none;
      }

      .section-editor-block.collapsed {
        margin-right: 20%;
        margin-bottom: 10px;
        display: block;
      }

      .section-editor-block.collapsed .section-left-column {
        margin-right: 20%;
        width: 100%;

      }

      .section-editor-block.collapsed .section-info-header {
        padding: 2px 2px;
        border-bottom: none;
      }

      .section-info-summary {
        font-size: 0.85em;
        opacity: 0.95;
        line-height: 1.4;
        margin-bottom: 2px;
      }

      .section-info-summary textarea {
        width: 100%;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        padding: var(--spacing-sm) 8px;
        border-radius: var(--border-radius);
        font-size: var(--font-size-sm);
        color: var(--text-primary);
        font-family: var(--font-editor);
        resize: vertical;
        min-height: 50px;
      }

      .section-info-tags {
        display: flex;
        flex-wrap: wrap;
        gap: var(--spacing-sm);
        align-items: center;
      }

      /* Make the inline editable tags use the same visual style as the Structure tags */
      .section-info-tag {
        background: #f3f3f3;
        color: #000000;
        padding: 2px 6px 2px 8px;
        border-radius: 3px;
        font-size: var(--font-size-xs);
        font-weight: 400;
        cursor: pointer;
        transition: background 0.2s;
        border: 1px solid var(--border-light);
        font-style: italic;
        display: inline-flex;
        align-items: center;
        gap: 4px;
      }

      .section-info-tag:hover {
        background: var(--bg-secondary);
      }

      .section-info-tag.removable::after {
        content: ' âœ•';
        opacity: 0.7;
        margin-left: var(--spacing-sm);
      }

      /* Tag input aligned with Structure small controls */
      .tag-add-input {
        background: transparent;
        border: 1px dashed var(--border-secondary);
        padding: 2px 6px;
        border-radius: 3px;
        font-size: var(--font-size-xs);
        width: auto;
        color: var(--text-primary);
      }

      .tag-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        background: var(--bg-tertiary);
        border: 1px solid var(--border-primary);
        border-radius: var(--border-radius);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        min-width: 150px;
        margin-top: 2px;
      }

      .tag-dropdown-option {
        padding: 6px 10px;
        cursor: pointer;
        font-size: 0.85em;
        color: var(--text-primary);
        border-bottom: 1px solid var(--border-tertiary);
      }

      .tag-dropdown-option:last-child {
        border-bottom: none;
      }

      .tag-dropdown-option:hover {
        background: var(--hover-bg);
      }

      .section-content-editor {
        padding: var(--spacing-xl);
        min-height: 250px;
        font-size: 16px;
        line-height: 1.8;
        outline: none;
        color: var(--text-primary);
        white-space: pre-wrap; /* Preserve whitespace and wrap text */
        word-wrap: break-word;
        font-family: var(--font-editor);
      }

      .section-content-editor:focus {
        background: #fefefe;
      }

      .section-content-editor p {
        margin-bottom: 1em;
        margin-top: 0;
        font-family: var(--font-editor);
      }

      .section-content-editor p:last-child {
        margin-bottom: 0;
      }

      .section-content-editor br {
        display: block;
        content: "";
        margin: 0.5em 0;
      }

      .section-content-editor:empty::before {
        content: 'Start writing your story here...';
        color: var(--text-secondary);
        font-style: italic;
      }

      .section-generate-btn {
        display: block;
        width: 100%;
        padding: 12px 20px;
        margin: 10px 0;
        background: var(--bg-card-inner);
        color: var(--text-primary);
        border: 2px solid var(--border-color);
        border-radius: var(--border-radius);
        font-size: 0.95em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      .section-generate-btn:hover:not(:disabled) {
        background: var(--hover-bg);
        border-color: var(--text-secondary);
        transform: translateY(-1px);
      }

      .section-generate-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      /* Scrollbar styling */
      .editor-main::-webkit-scrollbar,
      .editor-sidenotes::-webkit-scrollbar {
        width: 8px;
      }

      .editor-main::-webkit-scrollbar-track,
      .editor-sidenotes::-webkit-scrollbar-track {
        background: var(--bg-primary);
      }

      .editor-main::-webkit-scrollbar-thumb,
      .editor-sidenotes::-webkit-scrollbar-thumb {
        background: var(--text-secondary);
        border-radius: var(--border-radius);
      }

      .editor-main::-webkit-scrollbar-thumb:hover,
      .editor-sidenotes::-webkit-scrollbar-thumb:hover {
        background: var(--text-primary);
      }

      /* New Scene Button */
      .new-scene-btn {
        display: block;
        width: 100%;
        max-width: 600px;
        margin: 40px auto;
        padding: var(--spacing-xl);
        background: var(--bg-card-inner);
        border: 2px dashed var(--border-primary);
        border-radius: var(--border-radius-lg);
        color: var(--text-primary);
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
      }

      .new-scene-btn:hover {
        background: var(--hover-bg-light);
        border-color: var(--border-primary);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 54, 24, 0.2);
      }

      .new-scene-btn:active {
        transform: translateY(0);
      }

      /* Discrete insert button between sections */
      .section-insert-container {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 30px;
        margin: 1px 0;
        position: relative;
      }

      .section-insert-line {
        position: absolute;
        left: 0;
        right: 0;
        top: 50%;
        height: 2px;
        background: #666;
        opacity: 0.6;
        transform: translateY(-50%);
      }

      .section-insert-btn {
        position: relative;
        width: 24px;
        height: 24px;
        padding: 0;
        background: var(--bg-primary);
        border: 2px solid #666;
        border-radius: 50%;
        color: #888;
        font-size: 14px;
        font-weight: 400;
        cursor: pointer;
        transition: all 0.2s ease;
        z-index: 2;
      }

      .section-insert-btn:hover {
        background: var(--bg-card);
        border-color: var(--text-primary);
        color: var(--text-primary);
        transform: scale(1.15);
      }

      .section-insert-btn:active {
        transform: scale(0.95);
      }

      .section-insert-btn .insert-icon {
        display: block;
        line-height: 1;
      }

      /* Section Word Count */
      .section-word-count {
        font-size: 0.75em;
        color: #999;
        text-align: right;
        padding: 4px 8px;
        opacity: 0.7;
        font-style: italic;
      }

      /* Scene Settings Panel */
      .scene-settings-panel {
        background: var(--bg-card-inner);
        border: 1px solid var(--border-tertiary);
        border-radius: var(--border-radius);
        padding: var(--spacing-lg);
        margin: var(--spacing-sm) 0;
        overflow: hidden;
        transition: max-height 0.3s ease, opacity 0.3s ease;
      }

      .settings-row {
        display: flex;
        gap: var(--spacing-lg);
        align-items: flex-end;
      }

      .settings-group {
        margin-bottom: var(--spacing-lg);
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .settings-group:last-child {
        margin-bottom: 0;
      }

      .settings-group-inline {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
        flex: 1;
        min-width: 0;
      }

      .narrator-group {
        flex: 0.6;
        transition: opacity 0.2s ease;
      }

      .settings-label {
        font-size: 0.85em;
        font-weight: 600;
        color: var(--text-primary);
        display: block;
      }

      .settings-select,
      .settings-input {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid var(--border-tertiary);
        border-radius: var(--border-radius);
        font-size: 0.9em;
        background: var(--bg-tertiary);
        color: var(--text-primary);
        font-family: inherit;
      }

      .settings-select:focus,
      .settings-input:focus {
        outline: none;
        border-color: var(--border-secondary);
      }

      .section-config-btn.active {
        background: var(--bg-secondary);
        color: var(--text-primary);
      }

      /* AI Panel Styles */
      .ai-panel {
        position: fixed;
        top: 60px;
        left: 0;
        right: 0;
        bottom: 0;
        background: var(--bg-primary);
        z-index: 50;
        display: flex;
        flex-direction: column;
        transition: left 0.3s ease;
      }

      /* Info Panel Styles - Editorial Design */
      #info-panel .panel-content {
        background: #E8E4DC;
        padding: var(--spacing-xl);
      }

      .info-panel-content {
        max-width: 900px;
        margin: 0 auto;
        width: 100%;
      }

      .info-book-title {
        font-size: 72px;
        font-weight: bold;
        line-height: 0.9;
        margin: 0 0 var(--spacing-xl) 0;
        color: var(--text-primary);
        letter-spacing: -2px;
      }

      .info-section {
        margin-bottom: var(--spacing-xl);
        padding-bottom: var(--spacing-xl);
        border-bottom: 1px solid #000;
      }

      .info-section:last-child {
        border-bottom: none;
      }

      .info-section-number {
        display: none;
        font-size: 48px;
        font-weight: bold;
        line-height: 1;
        margin: 0 0 var(--spacing-sm) 0;
        color: var(--text-primary);
      }

      .info-section-title {
        font-size: var(--font-size-sm);
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 0 0 var(--spacing-md) 0;
        color: var(--text-primary);
        font-weight: normal;
      }

      .info-section-content {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: var(--spacing-lg);
        font-size: var(--font-size-sm);
        line-height: 1.6;
      }

      .info-label {
        font-weight: normal;
        color: var(--text-primary);
      }

      .info-value {
        color: var(--text-primary);
      }

      .info-stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: var(--spacing-lg);
      }

      .info-stat-item {
        display: flex;
        flex-direction: column;
      }

      .info-stat-number {
        font-size: 32px;
        font-weight: bold;
        line-height: 1;
        margin-bottom: var(--spacing-xs);
      }

      .info-stat-label {
        font-size: var(--font-size-xs);
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .info-editable-field {
        background: transparent;
        border: none;
        border-bottom: 1px solid transparent;
        padding: var(--spacing-xs) 0;
        font-family: var(--font-primary);
        font-size: inherit;
        color: var(--text-primary);
        width: 100%;
        transition: border-color 0.2s;
      }

      .info-editable-field:hover {
        border-bottom-color: var(--text-secondary);
      }

      .info-editable-field:focus {
        outline: none;
        border-bottom-color: var(--text-primary);
      }

      .info-textarea {
        background: transparent;
        border: 1px solid transparent;
        padding: var(--spacing-sm);
        font-family: var(--font-primary);
        font-size: inherit;
        color: var(--text-primary);
        width: 100%;
        min-height: 100px;
        resize: vertical;
        line-height: 1.6;
        transition: border-color 0.2s;
      }

      .info-textarea:hover {
        border-color: var(--text-secondary);
      }

      .info-textarea:focus {
        outline: none;
        border-color: var(--text-primary);
      }

      /* Adjust AI panel when config panel is open */
      body:has(#codex-config-panel.expanded) .ai-panel {
        left: 250px;
      }

      body:has(#codex-entry-panel.expanded) .ai-panel {
        left: 430px;
      }

      .ai-panel-header {
        background: var(--bg-primary);
        color: var(--text-primary);
        padding: var(--spacing-md) var(--spacing-lg);
        display: flex;
        align-items: center;
        gap: var(--spacing-md);
        box-shadow: none;
        border-bottom: var(--border-dotted);
      }

      .ai-panel-header h2 {
        margin: 0;
        font-size: var(--font-size-lg);
        font-weight: normal;
      }

      .ai-panel-content {
        flex: 1;
        overflow-y: auto;
        padding: var(--spacing-lg);
      }

      .ai-config-section,
      .ai-prompts-section {
        background: var(--bg-primary);
        border-radius: 0;
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
        box-shadow: none;
        border: var(--border-dotted);
      }

      .ai-config-section h3,
      .ai-prompts-section h3 {
        margin: 0 0 var(--spacing-md) 0;
        font-size: var(--font-size-base);
        color: var(--text-primary);
        border-bottom: var(--border-dotted);
        padding-bottom: var(--spacing-xs);
        font-weight: normal;
      }

      .ai-config-field {
        margin-bottom: var(--spacing-md);
      }

      .ai-config-field label {
        display: block;
        margin-bottom: var(--spacing-xs);
        font-weight: normal;
        color: var(--text-primary);
        font-size: var(--font-size-xs);
      }

      /* API Connection Group - Visual grouping box */
      .ai-api-connection-group {
        background: var(--bg-primary);
        border: var(--border-dotted);
        border-radius: 0;
        padding: var(--spacing-md);
        margin-bottom: var(--spacing-lg);
      }

      .ai-api-connection-group .ai-config-field {
        margin-bottom: var(--spacing-sm);
      }

      .ai-api-connection-group .ai-config-field:last-child {
        margin-bottom: 0;
      }

      .ai-input {
        width: 100%;
        padding: var(--spacing-xs) var(--spacing-sm);
        border: var(--border-width) dotted var(--border-light);
        border-radius: 0;
        font-size: var(--font-size-sm);
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: border-color 0.2s;
        box-sizing: border-box;
      }

      .ai-input:focus {
        outline: none;
        border-color: var(--border-primary);
        border-style: solid;
      }

      .ai-config-buttons {
        display: flex;
        gap: var(--spacing-sm);
        margin-top: var(--spacing-md);
      }

      .ai-btn {
        flex: 1;
        padding: var(--spacing-xs) var(--spacing-md);
        border: var(--border-width) solid var(--border-light);
        border-radius: 0;
        font-size: var(--font-size-xs);
        font-weight: normal;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--spacing-xs);
        background: transparent;
      }

      .ai-btn-primary {
        background: transparent;
        color: var(--text-primary);
        border-color: var(--border-primary);
      }

      .ai-btn-primary:hover {
        background: var(--bg-accent);
        color: var(--text-on-dark);
        border-color: var(--bg-accent);
      }

      .ai-btn-secondary {
        background: transparent;
        color: var(--text-primary);
        border-color: var(--border-light);
      }

      .ai-btn-secondary:hover {
        text-decoration: line-through;
      }

      .ai-prompts-list {
        display: flex;
        flex-direction: column;
        gap: var(--spacing-sm);
      }

      .ai-prompt-item {
        background: var(--bg-primary);
        border: var(--border-dotted);
        border-radius: 0;
        padding: var(--spacing-md);
        transition: all 0.2s;
        cursor: pointer;
      }

      .ai-prompt-item:hover {
        background: var(--bg-hover);
        border-color: var(--border-primary);
      }

      .ai-prompt-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--spacing-xs);
      }

      .ai-prompt-name {
        font-weight: normal;
        font-size: var(--font-size-sm);
        color: var(--text-primary);
      }

      .ai-prompt-edit-btn {
        background: transparent;
        border: var(--border-width) solid var(--border-light);
        color: var(--text-primary);
        padding: 4px 10px;
        border-radius: var(--border-radius);
        font-size: 0.8em;
        cursor: pointer;
        transition: all 0.2s;
      }

      .ai-prompt-edit-btn:hover {
        background: var(--hover-bg);
      }

      .ai-prompt-description {
        font-size: 0.85em;
        color: var(--text-secondary);
        line-height: 1.5;
        max-height: 60px;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* AI Config Message Styles */
      .ai-config-message {
        margin-top: var(--spacing-lg);
        padding: 10px 15px;
        border-radius: var(--border-radius);
        font-size: 0.9em;
        line-height: 1.5;
        animation: slideDown 0.3s ease-out;
      }

      .ai-config-message.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .ai-config-message.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .ai-config-message.info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
    </style>

    <!-- Load all modules in order -->
    <script src="js/data.js"></script>
    <script src="js/codex.js"></script>
    <script src="js/filter.js"></script>
    <script src="js/i18n-config.js"></script>
    <script src="js/prompts.js"></script>
    <script src="js/llm.js"></script>
    <script src="js/ai-panel.js"></script>
    <script src="js/renderer.js"></script>
    <script src="js/dragdrop.js"></script>
    <script src="js/modals.js"></script>
    <script src="js/editor.js"></script>
    <script src="js/section-editor.js"></script>
    <script src="js/events.js"></script>
    <script src="js/publisher.js"></script>
    <script src="js/app.js"></script>
  </body>
</html>